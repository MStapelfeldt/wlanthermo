automation:
  - id: '1565774399160_1'
    alias: WLANThermo update channels from MQTT
    description: ''
    trigger:
      - platform: state
        entity_id:
          - sensor.wlanthermo_channel_1_all
          - sensor.wlanthermo_channel_2_all
          - sensor.wlanthermo_channel_3_all
          - sensor.wlanthermo_channel_4_all
          - sensor.wlanthermo_channel_5_all
          - sensor.wlanthermo_channel_6_all
          - sensor.wlanthermo_channel_7_all
          - sensor.wlanthermo_channel_8_all
          - sensor.wlanthermo_channel_9_all
        #attribute: name
      - platform: state
        entity_id: sensor.bbq_thermo
        from: unknown
    conditions:
    - condition: template
      value_template: '{{ trigger.to_state.state != ''unavailable'' }}'
    action:
      - service: input_number.set_value
        data:
          entity_id: "input_number.wlanthermo_channel_{{ trigger.entity_id.split('_')[2] }}_min"
          value: "{{ state_attr(trigger.entity_id, 'min') }}"
      - service: input_number.set_value
        data:
          entity_id: "input_number.wlanthermo_channel_{{ trigger.entity_id.split('_')[2] }}_max"
          value: "{{ state_attr(trigger.entity_id, 'max') }}"
      - service: input_text.set_value
        data:
          entity_id: "input_text.wlanthermo_channel_{{ trigger.entity_id.split('_')[2] }}_name"
          value: "{{ state_attr(trigger.entity_id, 'name') }}"
    mode: restart
  - id: 1565774399160_min
    alias: WLANThermo set channel min
    trigger:
    - platform: state
      entity_id:
      - input_number.wlanthermo_channel_1_min
      - input_number.wlanthermo_channel_2_min
      - input_number.wlanthermo_channel_3_min
      - input_number.wlanthermo_channel_4_min
      - input_number.wlanthermo_channel_5_min
      - input_number.wlanthermo_channel_6_min
      - input_number.wlanthermo_channel_7_min
      - input_number.wlanthermo_channel_8_min
      - input_number.wlanthermo_channel_9_min
    condition: []
    action:
    - data:
        topic: !secret wlanthermo_set_topic
        retain: true
        payload: '{% set num = trigger.entity_id.split(''_'')[3] %} {"number": {{ num
          }}, "min": "{{ states(trigger.entity_id) }}"}

          '
      service: mqtt.publish
    mode: queued
  - id: 1565774399160_max
    alias: WLANThermo set channel max
    trigger:
    - platform: state
      entity_id:
      - input_number.wlanthermo_channel_1_max
      - input_number.wlanthermo_channel_2_max
      - input_number.wlanthermo_channel_3_max
      - input_number.wlanthermo_channel_4_max
      - input_number.wlanthermo_channel_5_max
      - input_number.wlanthermo_channel_6_max
      - input_number.wlanthermo_channel_7_max
      - input_number.wlanthermo_channel_8_max
      - input_number.wlanthermo_channel_9_max
    condition: []
    action:
    - data:
        topic: !secret wlanthermo_set_topic
        retain: true
        payload: '{% set num = trigger.entity_id.split(''_'')[3] %} {"number": {{ num
          }}, "max": "{{ states(trigger.entity_id) }}"}
          '
      service: mqtt.publish
    mode: queued
  - id: 1565774399160_name
    alias: WLANThermo set channel name
    trigger:
    - entity_id:
      - input_text.wlanthermo_channel_1_name
      - input_text.wlanthermo_channel_2_name
      - input_text.wlanthermo_channel_3_name
      - input_text.wlanthermo_channel_4_name
      - input_text.wlanthermo_channel_5_name
      - input_text.wlanthermo_channel_6_name
      - input_text.wlanthermo_channel_7_name
      - input_text.wlanthermo_channel_8_name
      - input_text.wlanthermo_channel_9_name
      platform: state
    condition: []
    action:
    - data:
        topic: !secret wlanthermo_set_topic
        retain: true
        payload: '{% set num = trigger.entity_id.split(''_'')[3] %} {"number": {{ num
          }}, "name": "{{ states(trigger.entity_id) }}"}

          '
      service: mqtt.publish
    mode: queued
  - id: '1565774399161_pitmaster'
    alias: wlanthermo set pitmaster
    mode: queued
    trigger:
      - platform: state
        entity_id: input_number.wlanthermo_pitmaster_temp
    condition: []
    action:
      - service: mqtt.publish
        data:
          topic: WLanThermo/${wlanthermo_model}/set/pitmaster
          retain: true
          payload: >
            [
              {
                "id": 0,
                "channel": {{ state_attr('select.wlanthermo_pitmaster_channel','options').index(states('select.wlanthermo_pitmaster_channel')) + 1 }},
                "pid": {{ state_attr('select.wlanthermo_pitmaster_profile','options').index(states('select.wlanthermo_pitmaster_profile')) }},
                "value": {{ states('number.wlanthermo_pitmaster_value') }},
                "set": {{ states('input_number.wlanthermo_pitmaster_temp') }},
                "typ": "{{ states('select.wlanthermo_pitmaster_mode') }}"
              }
            ]

  - id: 1565867288687_wt_avail
    alias: WLANThermo Became Available
    description: ''
    mode: queued
    trigger:
    - platform: state
      entity_id: sensor.bbq_thermo
      from: unavailable
    condition: []
    action:
    - service: input_datetime.set_datetime
      data:
        timestamp: '{{ now().timestamp() }}'
      target:
        entity_id: input_datetime.wlanthermo_became_available
  - id: 1643554744561_timer
    alias: WLANThermo Channel Timer
    trigger:
    - entity_id:
      - sensor.wlanthermo_channel_1_timeleft
      - sensor.wlanthermo_channel_2_timeleft
      - sensor.wlanthermo_channel_3_timeleft
      - sensor.wlanthermo_channel_4_timeleft
      - sensor.wlanthermo_channel_5_timeleft
      - sensor.wlanthermo_channel_6_timeleft
      - sensor.wlanthermo_channel_7_timeleft
      - sensor.wlanthermo_channel_8_timeleft
      - sensor.wlanthermo_channel_9_timeleft
      below: 10
      for:
        minutes: 1
      trigger: numeric_state
    condition:
    - condition: template
      value_template: '{{ is_state(''input_boolean.wlanthermo_channel_'' ~ trigger.entity_id.split(''_'')[2]
        ~ ''_timeleft'', ''on'') }}
        '
    action:
    - service: notify.mobile_app_xiaomi_15t
      data:
        title: BBQ Zieltemperatur erreicht
        message: >
          {% set num = trigger.entity_id.split('_')[2] %}
          {% set sensor = 'sensor.wlanthermo_channel_' ~ num ~ '_all' %}
          Zieltemperatur von Sensor '{{ state_attr(sensor, 'name') }}' bald erreicht ({{ states(sensor) }} Â°C)

    mode: single
  - id: 1643554744561_toggle_channel
    alias: WlanThermo Toggle Channels
    mode: single
    trigger:
      - platform: state
        entity_id:
          - input_boolean.wlanthermo_channel_1_panel_show
          - input_boolean.wlanthermo_channel_2_panel_show
          - input_boolean.wlanthermo_channel_3_panel_show
          - input_boolean.wlanthermo_channel_4_panel_show
          - input_boolean.wlanthermo_channel_5_panel_show
          - input_boolean.wlanthermo_channel_6_panel_show
          - input_boolean.wlanthermo_channel_7_panel_show
          - input_boolean.wlanthermo_channel_8_panel_show
          - input_boolean.wlanthermo_channel_9_panel_show
          - input_boolean.wlanthermo_pitmaster_2_panel_show
        to: 'on'
    condition: []
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: >
            {% set all = [
              'input_boolean.wlanthermo_channel_1_panel_show',
              'input_boolean.wlanthermo_channel_2_panel_show',
              'input_boolean.wlanthermo_channel_3_panel_show',
              'input_boolean.wlanthermo_channel_4_panel_show',
              'input_boolean.wlanthermo_channel_5_panel_show',
              'input_boolean.wlanthermo_channel_6_panel_show',
              'input_boolean.wlanthermo_channel_7_panel_show',
              'input_boolean.wlanthermo_channel_8_panel_show',
              'input_boolean.wlanthermo_channel_9_panel_show',
              'input_boolean.wlanthermo_pitmaster_2_panel_show'
            ] %}
            {{ all | reject('eq', trigger.entity_id) | list }}
